{% include "header.html" %}
<div class="card mb-3">
  <img src="{{prod.img_url}}" class="card-img-top" alt="...">
  <div class="card-body">
    <h5 class="card-title">{{prod.product_name}}</h5>
    <p class="card-text">{{prod.product_description}}</p>
    <ul class="list-group list-group-flush">
      <li class="list-group-item">{{prod.price}}</li>
      <li><form id="kart-form{{prod.id}}" data-id="{{prod.id}}" class="cart-input" action="{{url_for('add_to_cart')}}" method="post">
        <div class=""></div>
        <label for="cart-item">Qty</label>
        <input type="hidden" name="prod_id" id="prod_id{{prod.id}}" value="{{prod.id}}">
        <input class="" style="width: 20%;" type="number" name="quantity" id="cart-item{{prod.id}}" min="1" required>
        <input class="btn btn-outline-success" type="submit" value="Add to cart">
      </form>
    </li>
    </ul>
    
  </div>
  {%if logged_in %}
  {%for ord in current_user.order%}
  {%if ord in prod_orders %}
  <form action="" method="post" id="review_form" data-id="{{prod.id}}">
    <label for="rating">Rate product</label>
    <input type="number" name="rating" id="rating" max="5" min="1" required>
    <label for="review">Review product</label>
    <textarea name="review" id="review" cols="30" rows="10" maxlength="150" required>Great Product</textarea>
     <input class="btn btn-outline-success" type="submit" value="Submit">
  </form>
  {%break%}
  {%endif%}
  {%endfor%}
  {%endif%}
  <div>
    {%for review in rev%}
    <ul class="commentList">
      <li>
          <div class="commenterImage">
            <img src="{{ 'zzz.sochi@gmail.com' | gravatar }}">
          </div>
          <div class="commentText">
            <small>Rating: {{review.rating}}</small>
            <p>{{review.review}}</p>


            <span class="date sub-text">{{review.customer.first_name}} {{review.customer.last_name}}  </span>
             
          </div>
      </li>
    </ul>
  {%endfor%}

  </div>
  <script>
    const Revform = document.getElementById("review_form")
    console.log(Revform)
    Revform.onsubmit = function(e) {
      const prodctId = e.target.dataset["id"]

      e.preventDefault();
      const rate = document.getElementById("rating").value
      const rev = document.getElementById("review").value
      
      fetch("/add-rating/" + prodctId, {
        method: "POST",
        body: JSON.stringify({
          "rate": rate,
          "rev": rev
        }),
        headers: {
          "Content-Type": "application/json"
        }
      })

      .then(function (response) {
            return response.json();
        })
      .then(function (jsonResponse) {
                console.log(jsonResponse)
                if (jsonResponse) {
                    console.log("success")
                    window.location.href = `/product?id=${prodctId}`
                }
              })

      .catch(function () {
            alert(`Something went wrong`);
        })
    }
  </script>

  <script>
    const cartInput = document.querySelector(`.cart-input`);
    console.log(cartInput);
    cartInput.onsubmit = function (e) {

        const id_num = e.target.dataset['id']
    console.log(id_num)
    console.log(e)

    e.preventDefault();
    const qty = document.getElementById(`cart-item${id_num}`).value
    const prod_id = document.getElementById(`prod_id${id_num}`).value
    console.log(qty, prod_id)
    fetch("/add-to-cart", {
        method: "POST",
        body: JSON.stringify({
            "qty": qty,
            "prod_id": prod_id
        }),
        headers: {
            "Content-Type": "application/json"
        }
    })
        .then(function (response) {
            return response.json();
        })
        .then(function (jsonResponse) {
            console.log(jsonResponse);
            const feedback = jsonResponse['message'];
            alert(feedback)
            document.getElementById(`cart-item${id_num}`).value = ""

        })
        .catch(function () {
            alert(`Something went wrong`);
        })
}

  </script>

  {% include "footer.html" %}